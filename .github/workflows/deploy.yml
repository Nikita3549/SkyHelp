name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment to deploy"
        required: true
        default: "prod"
        type: choice
        options:
          - prod
  push:
    branches:
      - master

env:
  DOCKER_REPO: ${{ secrets.DOCKER_USERNAME }}/skyhelp-api
  IMAGE_TAG: sha-${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Short SHA
        id: vars
        run: echo "short_sha=$(echo ${GITHUB_SHA::7})" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          context: .
          push: true
          tags: |
              ${{ secrets.DOCKER_USERNAME }}/skyhelp-api:sha-${{ steps.vars.outputs.short_sha }}
              ${{ secrets.DOCKER_USERNAME }}/skyhelp-api:latest
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    env:
      FINAL_TAG: sha-${{ needs.build-and-push.outputs.short_sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate .env
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            cd ~/SkyHelp || exit 1
            bash validate-env.sh
            
            cd ~/SkyHelpDev || exit 1
            bash validate-env.sh

      - name: Deploy PROD
        uses: appleboy/ssh-action@v0.1.10
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          envs: FINAL_TAG
          script: |
            cd ~/SkyHelp || exit 1
            STABLE_TAG="prod-stable"
          
            git pull origin master || { echo "‚ùå Git pull failed"; exit 1; }
            
            export IMAGE_TAG=${{ env.FINAL_TAG }}
            
            docker compose --profile api pull

            source .env
            docker exec -i db-static psql \
              -U "$DATABASE_STATIC_USER" \
              -d "$DATABASE_STATIC_DBNAME" \
              -f /docker-entrypoint-initdb.d/update.sql

            if ! docker compose --profile api --profile elasticsearch up -d --remove-orphans --wait; then
              echo "‚ùå Docker Compose failed - rolling back"
              export IMAGE_TAG=$STABLE_TAG
            
              docker compose --profile api pull
              
              docker compose --profile api --profile elasticsearch up -d --remove-orphans
              exit 1
            fi

            echo "‚úÖ PROD Deployment complete"
      - name: Promote to prod-stable
        if: success() && github.event_name == 'workflow_dispatch'
        run: |
          REPO=${{ env.DOCKER_REPO }}
          FINAL_TAG="${{ env.FINAL_TAG }}"
          STABLE="prod-stable"
          
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          docker pull $REPO:$FINAL_TAG
          docker tag $REPO:$FINAL_TAG $REPO:$STABLE
          docker push $REPO:$STABLE
      - name: Deploy DEV
        uses: appleboy/ssh-action@v0.1.10
        if: |
          github.event_name == 'push' || 
          (github.event_name == 'workflow_dispatch' && github.event.inputs.environment != 'prod')
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          envs: FINAL_TAG
          script: |
            cd ~/SkyHelpDev || exit
            
            git pull origin master || { echo "‚ùå Git pull failed"; exit 1; }
            
            export IMAGE_TAG=${{ env.FINAL_TAG }}

            docker compose --profile api pull
            
            source .env
            docker exec -i dev_db-static psql \
              -U "$DATABASE_STATIC_USER" \
              -d "$DATABASE_STATIC_DBNAME" \
              -f /docker-entrypoint-initdb.d/update.sql

            echo "üîß Building and restarting DEV containers"
            docker compose -f docker-compose.yml -f docker-compose.dev.yml -p dev --profile api up -d --remove-orphans

            echo "‚úÖ DEV Deployment complete"